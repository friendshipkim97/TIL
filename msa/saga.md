# MSA

## SAGA패턴을 사용하기 전, 2PC기법
2PC기법이란, Two-Phase Commit의 약자로, 트랜잭션을 커밋할지, 롤백할지에 대해 분산 원자적 트랜잭션에 관여하는 분산 알고리즘의 하나이다. 

2PC에서 하나의 노드는 조정자와 트랜잭션의 대상이 되는 참가자들로 구성된다. 조정자는 커밋할 트랜잭션을 만드는 노드이며 참가자는 조정자가 보낸 트랜잭션을 커밋하거나 되돌린다. 

즉, 분산환경에서 데이터 신뢰성 향상을 위한 방안이다.

## 2PC기법의 단점
조정자에 오류가 발생한다면, 모든 트랜잭션이 조정자가 복구될 때 까지 지연된다는 단점, 조정자에 오류가 발생해 응답을 받지 못하면 참가자 전체가 블로킹에 빠지게 된다는 점이 있다.

## SAGA패턴이란?
SAGA 패턴이란 마이크로서비스들끼리 이벤트를 주고 받아 특정 마이크로서비스에서의 작업이 실패하면 이전까지의 작업이 완료된 마이크서비스들에게 보상 (complemetary) 이벤트를 소싱함으로써 분산 환경에서 원자성(atomicity)을 보장하는 패턴이다. 

즉, 여러 서비스간에 데이터 일관성을 유지하는 방법이다. 각 서비스의 로컬 트랜잭션을 순차적으로 처리하는 패턴이며, 각 로컬 트랜잭션은 자신의 데이터베이스를 업데이트한 후 SAGA내에 있는 다음 로컬 트랜잭션을 트리거하는 메세지 또는 이벤트를 게시하는 기법이다. 

## SAGA패턴 성공시 동작 예제
3개의 어플리케이션이 있다고 가정을 할때, 서비스 A는 Local 트랜잭션을 완료하면 완료이벤트를 서비스 B에 전달한다. 이후 서비스 B는 Local 트랜잭션을 완료하고, 완료이벤트를 서비스C에 전달한다. 서비스C는 Local 트랜잭션을 완료하고 완료이벤트를 서비스A에 전달한다. 최종적으로 서비스A는 트랜잭션을 종료한다. 
![](https://user-images.githubusercontent.com/42582516/102894284-33d83780-44a6-11eb-9cb0-1c526edd5642.png)

## SAGA패턴 실패시 동작 예제
3개의 어플리케이션이 있다고 가정을 할 때, 서비스 A는 Local트랜잭션을 완료한다. 이후, 완료이벤트를 서비스B에 전달한다. 서비스B는 Local트랜잭션을 완료한다. 이후, 완료이벤트를 서비스C에 전달한다. 서비스C가 Local 트랜잭션에 실패하면, 서비스C는 실패 이벤트를 서비스B에 전달한다. 서비스B는 Local 트랜잭션을 롤백한다. 서비스B는 서비스A에 트랜잭션 실패 이벤트를 전달한다. 최종적으로 서비스A는 트랜잭션을 롤백한다. 
![](https://user-images.githubusercontent.com/42582516/102894291-35a1fb00-44a6-11eb-93bf-2371f322c99c.png)

## SAGA패턴의 핵심
SAGA패턴은 트랜잭션의 관리주체가 DBMS가 아니라 Application에 있다. 즉,각각의 Application의 트랜잭션 실패로 인한 보상 트랜잭션은 Application이 구현한다. 순차적으로 트랜잭션을 처리하고, 마지막 트랜잭션이 끝났을 때, 데이터가 완전히 영속되었음을 확인하고 종료한다. 이 방법을 통해 데이터의 일관성을 달성할 수 있다. 

## SAGA패턴의 종류
SAGA패턴에는 다음과 같이2가지 종류가 있다.

* Choreography based SAGA pattern 
</br>
중앙 제어 서비스 없이 각각의 서비스에서 Local Transaction을 처리하면서, 이벤트나 메세지를 전하는 방식이다.
</br>
장점으로는 구성하기 편하지만, 단점으로는 트랜잭션의 현재 상태를 확인하기 어렵다는 점이 있다.

* Orchestration based SAGA pattern
</br>
중앙 제어 서비스가 각각의 서비스들의 통합 트랜잭션을 관리하는 방식이다. 
</br>
장점으로는 서비스 간의 복잡성이 줄어 구현과 테스트가 쉽고, Choreography based SAGA pattern과는 다르게 트랜잭션의 현재 상태를 알 수 있어 롤백을 하기 쉽다는 점이 있다.  단점으로는 Orchestrator서비스가 추가되어야 하기 때문에 인프라 구현이 복잡하다는 점이 있다. 

## 트랜잭션이란?
데이터베이스의 상태를 변화시키기 위해서 수행하는 작업의 단위이다.

## 원자성이란?
어떤 것이 더이상 쪼개질 수 없는 성질





[참조] https://azderica.github.io/01-architecture-msa/